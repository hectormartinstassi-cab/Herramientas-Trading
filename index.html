<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ArgBond Analytics - Dashboard Profesional</title>
    
    <!-- 1. Estilos: TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <style>
        @media print {
            body { background-color: white; color: black; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
    </style>

    <!-- 2. Import Map: CORREGIDO - STRICT React 18.2.0 -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0",
    "recharts": "https://esm.sh/recharts@2.10.3?deps=react@18.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/"
  }
}
</script>

    <!-- 3. Babel: Para entender el código React directamente en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-950 text-slate-200 antialiased min-h-screen">
    <div id="root"></div>

    <!-- 4. Lógica de la Aplicación -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            TrendingUp, Settings, PlusCircle, Calendar, Tag, FileInput, 
            Trash2, ArrowDown, ArrowUp, ChevronsUpDown, Filter, 
            TrendingDown, Target, Activity, LayoutDashboard, 
            Download, Upload, Printer, AlertCircle, Calculator, X 
        } from 'lucide-react';
        import { 
            ResponsiveContainer, ComposedChart, Line, Bar, XAxis, YAxis, 
            CartesianGrid, Tooltip, Legend, Cell 
        } from 'recharts';

        // --- UTILS & TYPES (Fusionados) ---

        const CalculationMethod = {
            SIMPLE: 'Simple (Lineal)',
            COMPOUND: 'Compuesto (Exponencial)',
        };

        const MILLISECONDS_PER_DAY = 1000 * 60 * 60 * 24;

        // Polyfill simple para ID si crypto.randomUUID no existe
        const generateId = () => {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        };

        const parseDateLocal = (dateString) => {
            if (!dateString) return new Date();
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        };

        const formatDateLocal = (dateString) => {
            if (!dateString) return '-';
            const date = parseDateLocal(dateString);
            return date.toLocaleDateString('es-AR', {
                day: '2-digit', month: '2-digit', year: 'numeric'
            });
        };

        const calculateDaysToMaturity = (maturityDate) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const maturity = parseDateLocal(maturityDate);
            const diffTime = maturity.getTime() - today.getTime();
            const days = Math.ceil(diffTime / MILLISECONDS_PER_DAY);
            return Math.max(0, days);
        };

        const calculateTheoreticalPrice = (redemptionValue, tnaPercent, days, method) => {
            const tna = tnaPercent / 100;
            const yearFraction = days / 365;

            if (days <= 0) return redemptionValue;

            if (method === CalculationMethod.SIMPLE) {
                return redemptionValue / (1 + (tna * yearFraction));
            } else {
                return redemptionValue / Math.pow(1 + tna, yearFraction);
            }
        };

        // --- COMPONENTS ---

        const DashboardHeader = ({ onOpenSettings }) => (
            <header className="flex items-center justify-between p-6 bg-slate-900 border-b border-slate-800 no-print">
                <div className="flex items-center gap-3">
                    <div className="p-2 bg-emerald-500/10 rounded-lg">
                        <TrendingUp className="w-6 h-6 text-emerald-400" />
                    </div>
                    <div>
                        <h1 className="text-xl font-bold text-white tracking-tight">ArgBond Analytics</h1>
                        <p className="text-sm text-slate-400">Renta Fija Argentina - Corto Plazo</p>
                    </div>
                </div>
                <button 
                    onClick={onOpenSettings}
                    className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-slate-300 bg-slate-800 rounded-lg hover:bg-slate-700 transition-colors border border-slate-700"
                >
                    <Settings className="w-4 h-4" />
                    <span>Configuración</span>
                </button>
            </header>
        );

        const SettingsPanel = ({ isOpen, onClose, params, setParams }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="w-full max-w-sm bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
                        <div className="flex items-center justify-between p-4 border-b border-slate-800 bg-slate-800/50">
                            <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                                <Calculator className="w-4 h-4 text-slate-400" />
                                Configuración Avanzada
                            </h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <X className="w-5 h-5" />
                            </button>
                        </div>
                        <div className="p-6 space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-slate-400 mb-3">
                                    Fórmula de Valoración (Descuento)
                                </label>
                                <div className="grid grid-cols-1 gap-2">
                                    {Object.values(CalculationMethod).map((method) => (
                                        <button
                                            key={method}
                                            onClick={() => setParams(prev => ({ ...prev, method }))}
                                            className={`px-4 py-3 rounded-lg text-sm font-medium text-left transition-all border flex items-center justify-between group ${
                                                params.method === method
                                                ? 'bg-emerald-500/10 border-emerald-500/50 text-emerald-400'
                                                : 'bg-slate-950 border-slate-800 text-slate-400 hover:border-slate-600 hover:bg-slate-800/50'
                                            }`}
                                        >
                                            <span>{method}</span>
                                            {params.method === method && <div className="w-2 h-2 rounded-full bg-emerald-500"></div>}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="p-4 border-t border-slate-800 bg-slate-800/30">
                            <button onClick={onClose} className="w-full py-2.5 bg-emerald-600 hover:bg-emerald-500 text-white font-semibold rounded-lg transition-colors">Listo</button>
                        </div>
                    </div>
                </div>
            );
        };

        const BondInput = ({ onAddBond }) => {
            const [ticker, setTicker] = useState('');
            const [maturityDate, setMaturityDate] = useState('');
            const [redemptionValue, setRedemptionValue] = useState('100');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!ticker || !maturityDate) return;
                onAddBond({
                    id: generateId(),
                    ticker: ticker.toUpperCase(),
                    maturityDate,
                    redemptionValue: Number(redemptionValue),
                });
                setTicker('');
            };

            return (
                <form onSubmit={handleSubmit} className="bg-slate-900/50 border border-slate-800 rounded-xl p-5 shadow-lg relative overflow-hidden no-print">
                    <div className="absolute top-0 left-0 w-1 h-full bg-slate-700"></div>
                    <div className="flex flex-col mb-4 pl-3">
                        <h3 className="text-white font-medium flex items-center gap-2">
                            <FileInput className="w-4 h-4 text-slate-400" />
                            Agregar Título a la Cartera
                        </h3>
                        <p className="text-xs text-slate-500 mt-1">Ingresa el Valor Técnico para calcular su precio hoy.</p>
                    </div>
                    <div className="flex flex-col md:flex-row gap-4 items-end w-full pl-3">
                        <div className="w-full md:w-1/3">
                            <label className="block text-xs font-medium text-slate-400 mb-1 flex items-center gap-1">
                                <Tag className="w-3 h-3" /> Ticker
                            </label>
                            <input
                                type="text"
                                placeholder="EJ: S31M4"
                                value={ticker}
                                onChange={(e) => setTicker(e.target.value)}
                                className="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-1 focus:ring-slate-500 outline-none placeholder:text-slate-700 uppercase"
                            />
                        </div>
                        <div className="w-full md:w-1/3">
                            <label className="block text-xs font-medium text-slate-400 mb-1 flex items-center gap-1">
                                <Calendar className="w-3 h-3" /> Vencimiento
                            </label>
                            <input
                                type="date"
                                value={maturityDate}
                                onChange={(e) => setMaturityDate(e.target.value)}
                                className="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-1 focus:ring-slate-500 outline-none [color-scheme:dark]"
                            />
                        </div>
                        <div className="w-full md:w-1/3">
                            <label className="block text-xs font-medium text-slate-400 mb-1">
                                Valor Técnico al Vencimiento (VF)
                            </label>
                            <input
                                type="number"
                                step="0.01"
                                value={redemptionValue}
                                onChange={(e) => setRedemptionValue(e.target.value)}
                                className="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-1 focus:ring-slate-500 outline-none text-right font-mono"
                            />
                        </div>
                        <button
                            type="submit"
                            disabled={!ticker || !maturityDate}
                            className="w-full md:w-auto px-6 py-2 bg-slate-100 hover:bg-white disabled:opacity-50 text-slate-900 font-semibold rounded-lg transition-colors flex items-center justify-center gap-2 min-w-[120px]"
                        >
                            <PlusCircle className="w-4 h-4" /> Agregar
                        </button>
                    </div>
                </form>
            );
        };

        const ScenarioControls = ({ params, setParams }) => {
            const updateParam = (field, value) => {
                setParams(prev => ({ ...prev, [field]: Number(value) }));
            };
            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 no-print">
                    <div className="bg-slate-900 border border-blue-900/40 rounded-xl p-5 relative overflow-hidden group shadow-lg shadow-blue-900/5 hover:border-blue-500/30 transition-all">
                        <div className="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                           <Target className="w-20 h-20 text-blue-400" />
                        </div>
                        <label className="text-blue-400 text-xs font-bold uppercase tracking-wider mb-3 flex items-center gap-2">
                          <Target className="w-4 h-4" /> TNA Objetivo (Escenario Base)
                        </label>
                        <div className="relative flex items-center">
                          <input type="number" step="0.5" value={params.targetTNA} onChange={(e) => updateParam('targetTNA', e.target.value)} className="w-full bg-transparent text-4xl font-mono font-bold text-white outline-none z-10 placeholder-slate-700" />
                          <span className="text-slate-500 font-medium text-xl absolute right-0">%</span>
                        </div>
                    </div>
                    <div className="bg-slate-900 border border-emerald-900/40 rounded-xl p-5 relative overflow-hidden group shadow-lg shadow-emerald-900/5 hover:border-emerald-500/30 transition-all">
                        <div className="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                           <TrendingUp className="w-20 h-20 text-emerald-400" />
                        </div>
                        <label className="text-emerald-400 text-xs font-bold uppercase tracking-wider mb-3 flex items-center gap-2">
                          <TrendingUp className="w-4 h-4" /> Spread Optimista (Baja Tasa)
                        </label>
                        <div className="relative flex items-center gap-2">
                           <span className="text-emerald-500 text-2xl font-bold">-</span>
                          <input type="number" step="0.5" value={params.optimisticSpread} onChange={(e) => updateParam('optimisticSpread', e.target.value)} className="w-full bg-transparent text-3xl font-mono font-bold text-white outline-none z-10" />
                           <span className="text-slate-500 font-medium text-lg absolute right-0">pts</span>
                        </div>
                    </div>
                    <div className="bg-slate-900 border border-rose-900/40 rounded-xl p-5 relative overflow-hidden group shadow-lg shadow-rose-900/5 hover:border-rose-500/30 transition-all">
                         <div className="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                           <TrendingDown className="w-20 h-20 text-rose-400" />
                        </div>
                        <label className="text-rose-400 text-xs font-bold uppercase tracking-wider mb-3 flex items-center gap-2">
                          <TrendingDown className="w-4 h-4" /> Spread Pesimista (Sube Tasa)
                        </label>
                        <div className="relative flex items-center gap-2">
                          <span className="text-rose-500 text-2xl font-bold">+</span>
                          <input type="number" step="0.5" value={params.pessimisticSpread} onChange={(e) => updateParam('pessimisticSpread', e.target.value)} className="w-full bg-transparent text-3xl font-mono font-bold text-white outline-none z-10" />
                          <span className="text-slate-500 font-medium text-lg absolute right-0">pts</span>
                        </div>
                    </div>
                </div>
            );
        };

        const ComparisonChart = ({ analysisData }) => {
            const [selectedTicker, setSelectedTicker] = useState('ALL');

            const allData = analysisData.map(item => ({
                ticker: item.bond.ticker,
                days: item.daysToMaturity,
                parityNormal: (item.scenarios.normal.price24h / item.bond.redemptionValue) * 100,
                priceNormal: item.scenarios.normal.price24h,
                parityOptimistic: (item.scenarios.optimistic.price24h / item.bond.redemptionValue) * 100,
                priceOptimistic: item.scenarios.optimistic.price24h,
                parityPessimistic: (item.scenarios.pessimistic.price24h / item.bond.redemptionValue) * 100,
                pricePessimistic: item.scenarios.pessimistic.price24h,
            }));

            const filteredData = selectedTicker === 'ALL' ? allData : allData.filter(d => d.ticker === selectedTicker);
            const uniqueTickers = Array.from(new Set(allData.map(d => d.ticker))).sort();

            const CustomTooltip = ({ active, payload, label }) => {
                if (active && payload && payload.length) {
                    const data = payload[0].payload;
                    return (
                        <div className="bg-slate-900 border border-slate-700 p-3 rounded-lg shadow-xl text-xs z-50">
                            <p className="font-bold text-white mb-2 text-sm">{label} <span className="text-slate-500 font-normal">({data.days}d)</span></p>
                            <div className="space-y-1">
                                <div className="flex justify-between gap-4 text-emerald-400"><span>Optimista (24h):</span><span className="font-mono font-bold">${data.priceOptimistic.toFixed(2)}</span></div>
                                <div className="flex justify-between gap-4 text-blue-400"><span>Objetivo (24h):</span><span className="font-mono font-bold">${data.priceNormal.toFixed(2)}</span></div>
                                <div className="flex justify-between gap-4 text-rose-400"><span>Pesimista (24h):</span><span className="font-mono font-bold">${data.pricePessimistic.toFixed(2)}</span></div>
                            </div>
                        </div>
                    );
                }
                return null;
            };

            return (
                <div className="w-full h-[400px] flex flex-col no-print">
                    <div className="mb-4 px-2 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <div>
                            <h3 className="text-sm font-semibold text-slate-300 uppercase tracking-wider">Análisis de Paridad Teórica (24hs)</h3>
                            <p className="text-xs text-slate-500 mt-1">Precio de entrada (Liq. 24hs) como porcentaje del Valor Técnico.</p>
                        </div>
                        <div className="flex items-center gap-2 bg-slate-950 p-1 rounded-lg border border-slate-800">
                            <Filter className="w-4 h-4 text-slate-500 ml-2" />
                            <select value={selectedTicker} onChange={(e) => setSelectedTicker(e.target.value)} className="bg-transparent text-slate-300 text-sm font-medium focus:outline-none p-1.5 rounded hover:bg-slate-900 cursor-pointer">
                                <option value="ALL">Mostrar Todos</option>
                                <option disabled className="text-slate-700">──────────</option>
                                {uniqueTickers.map(ticker => <option key={ticker} value={ticker}>{ticker}</option>)}
                            </select>
                        </div>
                    </div>
                    <div className="flex-1 w-full min-h-0">
                        <ResponsiveContainer width="100%" height="100%">
                            <ComposedChart data={filteredData} margin={{ top: 20, right: 30, left: 0, bottom: 5 }}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#1e293b" vertical={false} />
                                <XAxis dataKey="ticker" tick={{ fill: '#94a3b8', fontSize: 11 }} axisLine={{ stroke: '#334155' }} tickLine={false} />
                                <YAxis unit="%" tick={{ fill: '#64748b', fontSize: 11 }} axisLine={false} tickLine={false} domain={['auto', 'auto']} />
                                <Tooltip content={<CustomTooltip />} cursor={{ fill: '#1e293b', opacity: 0.4 }} />
                                <Legend wrapperStyle={{ fontSize: '11px', paddingTop: '10px' }} iconSize={8} />
                                <Bar dataKey="parityNormal" name="Paridad Objetivo" barSize={selectedTicker === 'ALL' ? 30 : 60} fill="#3b82f6" radius={[4, 4, 0, 0]}>
                                    {filteredData.map((entry, index) => <Cell key={`cell-${index}`} fill="url(#colorGradient)" />)}
                                </Bar>
                                <Line type="monotone" dataKey="parityOptimistic" name="Tope Optimista" stroke="#10b981" strokeWidth={0} dot={{ r: 4, fill: '#10b981', strokeWidth: 0 }} activeDot={{ r: 6 }} />
                                <Line type="monotone" dataKey="parityPessimistic" name="Suelo Pesimista" stroke="#e11d48" strokeWidth={0} dot={{ r: 4, fill: '#e11d48', strokeWidth: 0 }} activeDot={{ r: 6 }} />
                                <defs>
                                    <linearGradient id="colorGradient" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.8}/>
                                        <stop offset="95%" stopColor="#3b82f6" stopOpacity={0.3}/>
                                    </linearGradient>
                                </defs>
                            </ComposedChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            );
        };

        const BondTable = ({ analysisData, onRemove, sortConfig, onSort }) => {
            const getSortIcon = (columnKey) => {
                if (sortConfig.key !== columnKey) return <ChevronsUpDown className="w-3 h-3 text-slate-600 print:text-slate-400" />;
                return sortConfig.direction === 'asc' 
                ? <ArrowUp className="w-3 h-3 text-emerald-400 print:text-black" /> 
                : <ArrowDown className="w-3 h-3 text-emerald-400 print:text-black" />;
            };

            const HeaderCell = ({ label, sortKey, align = 'left', className = '' }) => (
                <th 
                className={`p-4 text-xs font-semibold text-slate-400 uppercase tracking-wider ${align === 'right' ? 'text-right' : align === 'center' ? 'text-center' : 'text-left'} ${className} ${sortKey ? 'cursor-pointer hover:text-white hover:bg-slate-900 transition-colors select-none print:hover:bg-white print:text-slate-600' : ''}`}
                onClick={() => sortKey && onSort(sortKey)}
                >
                <div className={`flex items-center gap-1 ${align === 'right' ? 'justify-end' : align === 'center' ? 'justify-center' : 'justify-start'}`}>
                    {label}
                    {sortKey && <span className="no-print">{getSortIcon(sortKey)}</span>}
                </div>
                </th>
            );

            return (
                <div className="overflow-x-auto print:overflow-visible">
                    <table className="w-full text-left border-collapse print:border print:border-slate-300">
                        <thead>
                            <tr className="border-b border-slate-800 bg-slate-950/50 print:bg-slate-100 print:border-slate-300">
                                <HeaderCell label="Ticker" sortKey="ticker" className="w-24 print:w-auto" />
                                <HeaderCell label="Vencimiento" sortKey="maturityDate" align="center" />
                                <HeaderCell label="V. Técnico" sortKey="redemptionValue" align="right" />
                                <th className="p-4 text-xs font-semibold text-emerald-400/80 uppercase tracking-wider text-right bg-emerald-950/10 border-l border-emerald-900/20 print:bg-white print:text-black print:border-slate-300">Optimista</th>
                                <th className="p-4 text-xs font-semibold text-blue-400/80 uppercase tracking-wider text-right bg-blue-950/10 border-l border-blue-900/20 border-r print:bg-white print:text-black print:border-slate-300">Objetivo</th>
                                <th className="p-4 text-xs font-semibold text-rose-400/80 uppercase tracking-wider text-right bg-rose-950/10 border-r border-rose-900/20 print:bg-white print:text-black print:border-slate-300">Pesimista</th>
                                <th className="p-4 text-xs font-semibold text-slate-400 uppercase tracking-wider text-center w-16 no-print">Acción</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-800/50 print:divide-slate-300">
                        {analysisData.map((item) => (
                            <tr key={item.bond.id} className="hover:bg-slate-800/30 transition-colors group print:hover:bg-transparent">
                                <td className="p-4 print:py-2">
                                    <div className="font-bold text-white font-mono text-lg print:text-black">{item.bond.ticker}</div>
                                </td>
                                <td className="p-4 text-center print:py-2">
                                    <div className="text-sm text-slate-300 print:text-black">{formatDateLocal(item.bond.maturityDate)}</div>
                                    <div className="text-xs text-slate-500 font-mono mt-0.5 print:text-slate-600">{item.daysToMaturity} días</div>
                                </td>
                                <td className="p-4 text-right print:py-2">
                                    <div className="font-mono text-slate-300 font-medium text-lg print:text-black">
                                    ${item.bond.redemptionValue.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                    </div>
                                </td>
                                {['optimistic', 'normal', 'pessimistic'].map((key) => {
                                    const scenario = item.scenarios[key];
                                    const baseColor = key === 'optimistic' ? 'text-emerald-300' : key === 'normal' ? 'text-blue-300' : 'text-rose-300';
                                    const subColor = key === 'optimistic' ? 'text-emerald-500/60' : key === 'normal' ? 'text-blue-500/60' : 'text-rose-500/60';
                                    const borderColor = key === 'optimistic' ? 'border-emerald-500/10' : key === 'normal' ? 'border-blue-500/10' : 'border-rose-500/10';
                                    const bgClass = key === 'optimistic' ? 'bg-emerald-900/5' : key === 'normal' ? 'bg-blue-900/5' : 'bg-rose-900/5';
                                    
                                    return (
                                    <td key={key} className={`p-4 text-right font-mono ${baseColor} ${bgClass} border-l ${borderColor} ${key === 'normal' ? 'border-r' : ''} print:bg-white print:text-black print:border-slate-300`}>
                                        <div className="flex flex-col gap-1.5">
                                            {/* CI Section (Primary - Large) */}
                                            <div className="flex justify-between items-baseline">
                                                <span className="text-[9px] font-bold uppercase tracking-wider opacity-60 print:text-slate-500">CI</span>
                                                <span className="font-bold text-base print:text-black">
                                                    ${scenario.priceCI.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                </span>
                                            </div>
                                            {/* 24hs Section (Secondary - Small) */}
                                            <div className={`flex justify-between items-baseline pt-1.5 border-t ${borderColor} print:border-slate-200`}>
                                                <span className={`text-[9px] font-bold uppercase tracking-wider ${subColor} print:text-slate-500`}>24hs</span>
                                                <span className={`text-xs ${subColor} print:text-slate-700`}>
                                                    ${scenario.price24h.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                </span>
                                            </div>
                                        </div>
                                        <div className={`text-[9px] opacity-40 mt-1.5 text-right w-full print:text-slate-400`}>
                                            {(scenario.tna * 100).toFixed(1)}% TNA
                                        </div>
                                    </td>
                                    );
                                })}
                                <td className="p-4 text-center no-print">
                                    <button onClick={() => onRemove(item.bond.id)} className="p-2 text-slate-600 hover:text-rose-400 hover:bg-rose-950/30 rounded-lg transition-all" title="Eliminar">
                                        <Trash2 className="w-4 h-4" />
                                    </button>
                                </td>
                            </tr>
                        ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        // --- MAIN APP ---

        const DEFAULT_PARAMS = {
            targetTNA: 45.0,
            pessimisticSpread: 5.0,
            optimisticSpread: 5.0,
            method: CalculationMethod.COMPOUND
        };

        const App = () => {
            const [bonds, setBonds] = useState([]);
            const [params, setParams] = useState(DEFAULT_PARAMS);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [sortConfig, setSortConfig] = useState({ key: 'maturityDate', direction: 'asc' });
            const fileInputRef = useRef(null);

            useEffect(() => {
                const savedPortfolio = localStorage.getItem('argBondPortfolio');
                if (savedPortfolio) {
                    try { 
                        const parsed = JSON.parse(savedPortfolio);
                        // Lógica de migración: Si es array, es la versión vieja. Si es objeto con 'bonds', es la nueva.
                        if (Array.isArray(parsed)) {
                            setBonds(parsed);
                        } else if (parsed.bonds) {
                            setBonds(parsed.bonds);
                            if (parsed.params) setParams(parsed.params);
                        }
                    } catch (e) { console.error("Error parsing", e); }
                }
            }, []);

            useEffect(() => {
                // Ahora guardamos TODO (cartera + config)
                const dataToSave = { bonds, params };
                localStorage.setItem('argBondPortfolio', JSON.stringify(dataToSave));
            }, [bonds, params]);

            const handleAddBond = (newBond) => setBonds(prev => [...prev, newBond]);
            const handleRemoveBond = (id) => setBonds(prev => prev.filter(b => b.id !== id));
            
            const handleSort = (key) => {
                setSortConfig(current => ({
                    key,
                    direction: current.key === key && current.direction === 'asc' ? 'desc' : 'asc'
                }));
            };

            const handleExportPortfolio = () => {
                const exportData = {
                    version: '1.1',
                    generatedAt: new Date().toISOString(),
                    bonds,
                    params
                };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "cartera_bonos_full.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const handleFileChange = (event) => {
                const fileObj = event.target.files && event.target.files[0];
                if (!fileObj) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = e.target?.result;
                        if (typeof json === 'string') {
                            const parsed = JSON.parse(json);
                            if (Array.isArray(parsed)) {
                                setBonds(parsed);
                            } else if (parsed.bonds) {
                                setBonds(parsed.bonds);
                                if (parsed.params) setParams(parsed.params);
                            }
                        }
                    } catch (error) { alert("Error al leer el archivo JSON."); }
                };
                reader.readAsText(fileObj);
                event.target.value = '';
            };

            const analysisResults = useMemo(() => {
                const sortedBonds = [...bonds].sort((a, b) => {
                    let comparison = 0;
                    switch (sortConfig.key) {
                        case 'ticker': comparison = a.ticker.localeCompare(b.ticker); break;
                        case 'maturityDate': case 'daysToMaturity': comparison = new Date(a.maturityDate).getTime() - new Date(b.maturityDate).getTime(); break;
                        case 'redemptionValue': comparison = a.redemptionValue - b.redemptionValue; break;
                        default: comparison = 0;
                    }
                    return sortConfig.direction === 'asc' ? comparison : -comparison;
                });

                return sortedBonds.map(bond => {
                    const days = calculateDaysToMaturity(bond.maturityDate);
                    const daysCI = days; 
                    const days24h = Math.max(0, days - 1);
                    
                    const calcScenario = (targetTna, label) => ({
                        tna: targetTna / 100,
                        price24h: calculateTheoreticalPrice(bond.redemptionValue, targetTna, days24h, params.method),
                        priceCI: calculateTheoreticalPrice(bond.redemptionValue, targetTna, daysCI, params.method),
                        label
                    });

                    return {
                        bond,
                        daysToMaturity: days,
                        scenarios: {
                            normal: calcScenario(params.targetTNA, 'Normal'),
                            pessimistic: calcScenario(params.targetTNA + params.pessimisticSpread, 'Pesimista'),
                            optimistic: calcScenario(params.targetTNA - params.optimisticSpread, 'Optimista')
                        }
                    };
                });
            }, [bonds, params, sortConfig]);

            return (
                <div className="pb-20 print:pb-0">
                    <div className="no-print">
                        <DashboardHeader onOpenSettings={() => setIsSettingsOpen(true)} />
                    </div>
                    
                    <main className="max-w-7xl mx-auto px-4 py-8 print:p-0 print:max-w-none">
                        <section className="mb-8 no-print">
                            <h2 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4 px-1">
                                Definición de Escenarios de Rendimiento
                            </h2>
                            <ScenarioControls params={params} setParams={setParams} />
                        </section>

                        <div className="no-print">
                            <BondInput onAddBond={handleAddBond} />
                        </div>

                        <div className="space-y-6 mt-8 print:mt-0 print:space-y-4">
                            <div className="flex items-center justify-between border-b border-slate-800 pb-4 print:border-b-2 print:border-black print:pb-2">
                                <h2 className="text-xl font-bold text-white flex items-center gap-2 print:text-black">
                                    <LayoutDashboard className="w-5 h-5 text-emerald-400 no-print" />
                                    Tablero de Precios Sugeridos
                                    <span className="hidden print:inline text-sm font-normal ml-2">- Generado el {new Date().toLocaleDateString()}</span>
                                </h2>
                                
                                <div className="flex items-center gap-2 no-print">
                                    <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".json" className="hidden" />
                                    <button onClick={() => fileInputRef.current?.click()} className="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors border border-transparent hover:border-slate-700">
                                        <Upload className="w-3.5 h-3.5" /> Importar
                                    </button>
                                    <button onClick={handleExportPortfolio} disabled={bonds.length === 0} className="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors border border-transparent hover:border-slate-700 disabled:opacity-50">
                                        <Download className="w-3.5 h-3.5" /> Guardar
                                    </button>
                                    <div className="h-4 w-px bg-slate-800 mx-1"></div>
                                    <button onClick={() => window.print()} className="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-slate-900 bg-emerald-400 hover:bg-emerald-300 rounded-lg transition-colors font-semibold">
                                        <Printer className="w-3.5 h-3.5" /> Imprimir
                                    </button>
                                </div>
                            </div>

                            {bonds.length === 0 ? (
                                <div className="text-center py-24 bg-slate-900/50 rounded-2xl border border-dashed border-slate-800 print:border-slate-300">
                                    <div className="inline-flex p-4 bg-slate-800 rounded-full mb-4 ring-1 ring-slate-700 no-print">
                                        <AlertCircle className="w-10 h-10 text-slate-500" />
                                    </div>
                                    <h3 className="text-xl font-medium text-slate-300 print:text-black">Cartera Vacía</h3>
                                    <p className="text-slate-500 mt-2 text-sm print:text-slate-600">Agrega instrumentos arriba.</p>
                                </div>
                            ) : (
                                <div className="space-y-8 print:block">
                                    <section className="bg-slate-900 border border-slate-800 rounded-2xl p-6 shadow-xl overflow-hidden relative no-print">
                                        <ComparisonChart analysisData={analysisResults} />
                                    </section>
                                    <section className="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden shadow-xl print:shadow-none print:border-none print:bg-white print:rounded-none">
                                        <BondTable analysisData={analysisResults} onRemove={handleRemoveBond} sortConfig={sortConfig} onSort={handleSort} />
                                    </section>
                                </div>
                            )}
                        </div>
                    </main>

                    <div className="no-print">
                        <SettingsPanel isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} params={params} setParams={setParams} />
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>